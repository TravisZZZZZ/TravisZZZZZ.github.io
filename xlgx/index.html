<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¬£äº†ä¸ªæ¬£ï¼šå¸®åˆ˜é›…æ¬£é€ƒå‡ºè€ƒè¯•å‘¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #a4e372;
      font-family: sans-serif;
      overflow: hidden;
    }
    .pig {
      position: absolute;
      width: 50px;
      height: 50px;
      background-image: url('https://i.hd-r.icu/70cd5b60c67debaa86e51d8e1ca3e77e.png');
      background-size: contain;
      background-repeat: no-repeat;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .pig:hover {
      transform: scale(1.1);
    }
    #titleOverlay {
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 26px;
      font-weight: bold;
      color: #fff;
      text-shadow: 1px 1px 4px #000;
      z-index: 30;
    }
    #scoreBoard {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 18px;
      z-index: 10;
    }
    #medalSystem {
      position: absolute;
      top: 70px;
      left: 20px;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 18px;
      z-index: 10;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      max-width: 300px;
    }
    .medal {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      margin-right: 2px;
      margin-bottom: 2px;
      transition: transform 0.2s;
    }
    .medal:hover {
      transform: scale(1.2);
    }
    .medal-bronze {
      background: linear-gradient(135deg, #cd7f32 0%, #b87333 100%);
    }
    .medal-silver {
      background: linear-gradient(135deg, #c0c0c0 0%, #a9a9a9 100%);
    }
    .medal-gold {
      background: linear-gradient(135deg, #ffd700 0%, #ffcc00 100%);
    }
    .medal-diamond {
      background: linear-gradient(135deg, #b9f2ff 0%, #87ceeb 100%);
    }
    #message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 16px 24px;
      border-radius: 10px;
      font-size: 22px;
      text-align: center;
      display: none;
      z-index: 20;
      max-width: 80%;
    }
    #controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 11;
    }
    #controls button {
      position: relative;
      transition: all 0.2s;
    }
    #controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    #controls button::after {
      content: attr(data-desc);
      display: block;
      font-size: 12px;
      color: #fff;
      opacity: 0.85;
      margin-top: 2px;
      text-align: left;
    }
    #startBtnWrapper {
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 12;
    }
    button {
      padding: 12px 24px;
      font-size: 20px;
      border-radius: 8px;
      color: white;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    #startBtn {
      background-color: #ec4899;
    }
    #restartBtn {
      background-color: #eab308;
    }
    #shuffleBtn {
      background-color: #3b82f6;
    }
    #removeBtn {
      background-color: #ef4444;
    }
    #gameBoard {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    .level-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      margin-top: 8px;
      font-weight: bold;
    }
    .level-badge-beginner {
      background-color: #4ade80;
      color: #065f46;
    }
    .level-badge-intermediate {
      background-color: #fbbf24;
      color: #713f12;
    }
    .level-badge-advanced {
      background-color: #f43f5e;
      color: #881337;
    }
  </style>
</head>
<body>
  <div id="titleOverlay">ã€Šæ¬£äº†ä¸ªæ¬£ï¼šå¸®åˆ˜é›…æ¬£é€ƒå‡ºè€ƒè¯•å‘¨ã€‹</div>
  <div id="scoreBoard">å±€æ•°ï¼š<span id="round">0</span>ï½œå·²é€ƒå‡ºçš„åˆ˜é›…æ¬£ï¼š<span id="score">0</span></div>
  <div id="medalSystem"></div>
  <div id="gameBoard"></div>
  <div id="message"></div>

  <div id="controls">
    <button id="restartBtn" class="bg-yellow-500 hidden">é‡æ–°å¼€å§‹</button>
    <button id="shuffleBtn" class="bg-blue-500 hidden" data-desc="éšæœºæ”¹å˜æ‰€æœ‰çŒªçš„æ–¹å‘">è½¬å‘å¡ï¼ˆå‰©ä½™<span id="shuffleCount">2</span>ï¼‰</button>
    <button id="removeBtn" class="bg-red-500 hidden" data-desc="éšæœºç§»é™¤3åªçŒª">æ¸…é™¤å¡ï¼ˆå‰©ä½™<span id="removeCount">2</span>ï¼‰</button>
  </div>

  <div id="startBtnWrapper">
    <button id="startBtn" class="bg-pink-500">å¼€å§‹æ¸¸æˆ</button>
  </div>

<script>
(() => {
  const board = document.getElementById('gameBoard');
  const titleOverlay = document.getElementById('titleOverlay');
  const startBtn = document.getElementById('startBtn');
  const restartBtn = document.getElementById('restartBtn');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const removeBtn = document.getElementById('removeBtn');
  const shuffleCountEl = document.getElementById('shuffleCount');
  const removeCountEl = document.getElementById('removeCount');
  const scoreEl = document.getElementById('score');
  const roundEl = document.getElementById('round');
  const message = document.getElementById('message');
  const medalSystem = document.getElementById('medalSystem');
  const pigSize = 50;
  const speed = 10;
  const directions = ['up', 'right', 'down', 'left'];
  let pigs = [];
  let score = 0;
  let round = 0;
  let shuffleLeft = 2;
  let removeLeft = 2;
  let totalMedals = 0; // æ–°å¢ï¼šæ€»å¥–ç‰Œæ•°

  // è·å–å¥–ç‰Œç±»å‹ï¼ˆæ ¹æ®æ•°é‡ï¼‰
  function getMedalType(index) {
    if (index < 5) return 'bronze';
    if (index < 10) return 'silver';
    if (index < 15) return 'gold';
    return 'diamond';
  }

  // è·å–å¥–ç‰Œå›¾æ ‡
  function getMedalIcon(type) {
    const icons = {
      bronze: '<i class="fa fa-trophy text-xs"></i>',
      silver: '<i class="fa fa-star text-xs"></i>',
      gold: '<i class="fa fa-certificate text-xs"></i>',
      diamond: '<i class="fa fa-diamond text-xs"></i>'
    };
    return icons[type] || icons.bronze;
  }

  function getPigCountForRound(r) {
    return 20 + r;
  }

  function randomPos(max) {
    return Math.floor(Math.random() * (max - pigSize));
  }

  function isBlocked(x, y, exclude) {
    return pigs.some(p => {
      if (p === exclude || p.escaped) return false;
      const pSize = p.large ? pigSize * 1.5 : pigSize;
      const curSize = exclude?.large ? pigSize * 1.5 : pigSize;
      // æ›´ç²¾ç¡®çš„ç¢°æ’æ£€æµ‹
      return Math.abs(p.x + pSize / 2 - x - curSize / 2) < (pSize + curSize) / 2 && Math.abs(p.y + pSize / 2 - y - curSize / 2) < (pSize + curSize) / 2;
    });
  }

  function movePig(pigEl, pigData) {
    if (pigData.moving || pigData.escaped) return;
    pigData.moving = true;
    let { x, y, dir } = pigData;
    const pigSpeed = pigData.large ? speed / 2 : speed;

    function step() {
      let nextX = x;
      let nextY = y;
      if (dir === 'up') nextY -= pigSpeed;
      else if (dir === 'down') nextY += pigSpeed;
      else if (dir === 'left') nextX -= pigSpeed;
      else if (dir === 'right') nextX += pigSpeed;

      if (
        nextX < 0 ||
        nextY < 0 ||
        nextX > window.innerWidth - (pigData.large ? pigSize * 1.5 : pigSize) ||
        nextY > window.innerHeight - (pigData.large ? pigSize * 1.5 : pigSize)
      ) {
        pigEl.remove();
        pigData.escaped = true;
        pigData.moving = false;
        pigs = pigs.filter(p => p !== pigData);
        score++;
        scoreEl.textContent = score;
        
        // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦è¾¾åˆ°10åªçŒªï¼Œå¢åŠ å¥–ç‰Œ
        if (score % 10 === 0) {
          totalMedals++;
          updateMedalDisplay();
        }
        
        if (pigs.filter(p => !p.escaped).length === 0) {
          setTimeout(() => showVictory(), 300);
        }
        return;
      }

      if (isBlocked(nextX, nextY, pigData)) {
        pigData.moving = false;
        return;
      }

      x = nextX;
      y = nextY;
      pigData.x = x;
      pigData.y = y;
      pigEl.style.left = x + 'px';
      pigEl.style.top = y + 'px';
      requestAnimationFrame(step);
    }

    requestAnimationFrame(step);
  }

  function createPig(x, y, dir, isLarge = false) {
    const pig = document.createElement('div');
    pig.className = 'pig';
    if (isLarge) {
      pig.style.width = '75px';
      pig.style.height = '75px';
      pig.style.transformOrigin = 'center center';
    }
    pig.dataset.dir = dir;
    pig.style.left = x + 'px';
    pig.style.top = y + 'px';
    pig.style.transform = {
      up: 'rotate(0deg)',
      right: 'rotate(90deg)',
      down: 'rotate(180deg)',
      left: 'rotate(270deg)'
    }[dir];
    board.appendChild(pig);
    const pigSizeActual = isLarge ? pigSize * 1.5 : pigSize;
    const pigData = { el: pig, x, y, dir, moving: false, escaped: false, large: isLarge, size: pigSizeActual };
    pigs.push(pigData);
    pig.onclick = () => movePig(pig, pigData);
  }

  function shuffleDirections() {
    if (shuffleLeft <= 0) return;
    pigs.forEach(p => {
      if (!p.escaped && !p.moving) {
        const shuffledDirs = directions.sort(() => Math.random() - 0.5);
        p.dir = shuffledDirs[0];
        p.el.style.transform = {
          up: 'rotate(0deg)',
          right: 'rotate(90deg)',
          down: 'rotate(180deg)',
          left: 'rotate(270deg)'
        }[p.dir];
      }
    });
    shuffleLeft--;
    shuffleCountEl.textContent = shuffleLeft;
  }

  function removeRandomPigs(count = 3) {
    if (removeLeft <= 0) return;
    const candidates = pigs.filter(p => !p.escaped && !p.moving);
    for (let i = 0; i < Math.min(count, candidates.length); i++) {
      const idx = Math.floor(Math.random() * candidates.length);
      const pig = candidates[idx];
      pig.el.remove();
      pigs = pigs.filter(p => p !== pig);
      candidates.splice(idx, 1);
    }
    removeLeft--;
    removeCountEl.textContent = removeLeft;
    if (pigs.filter(p => !p.escaped).length === 0) {
      setTimeout(() => showVictory(), 300);
    }
  }

  // æ›´æ–°å¥–ç‰Œæ˜¾ç¤º
  function updateMedalDisplay() {
    medalSystem.innerHTML = '';
    
    // æ·»åŠ æ ‡é¢˜
    const title = document.createElement('div');
    title.textContent = 'å¥–ç‰Œæ”¶è—:';
    title.style.width = '100%';
    title.style.marginBottom = '4px';
    medalSystem.appendChild(title);
    
    // æ·»åŠ å¥–ç‰Œ
    for (let i = 0; i < totalMedals; i++) {
      const medalType = getMedalType(i);
      const medal = document.createElement('div');
      medal.className = `medal medal-${medalType}`;
      medal.innerHTML = getMedalIcon(medalType);
      medal.title = `${i + 1}. ${medalType.charAt(0).toUpperCase() + medalType.slice(1)} Medal`;
      medalSystem.appendChild(medal);
    }
    
    // æ·»åŠ æ€»æ•°å’Œç­‰çº§æ˜¾ç¤º
    const levelInfo = document.createElement('div');
    levelInfo.style.width = '100%';
    levelInfo.style.marginTop = '4px';
    
    const level = getLevel();
    const levelName = level <= 10 ? 'åˆçº§' : level <= 20 ? 'ä¸­çº§' : 'é«˜çº§';
    const levelClass = level <= 10 ? 'level-badge-beginner' : level <= 20 ? 'level-badge-intermediate' : 'level-badge-advanced';
    
    levelInfo.innerHTML = `
      <span style="margin-right: 8px;">æ€»å¥–ç‰Œ: ${totalMedals}</span>
      <span class="level-badge ${levelClass}">ç­‰çº§: ${levelName}</span>
    `;
    medalSystem.appendChild(levelInfo);
  }

  // è·å–å½“å‰ç­‰çº§
  function getLevel() {
    return Math.floor(totalMedals / 2) + 1;
  }

  function startGame() {
    board.innerHTML = '';
    message.style.display = 'none';
    titleOverlay.style.display = 'none';
    score = 0;
    scoreEl.textContent = score;
    pigs = [];
    startBtn.style.display = 'none';
    restartBtn.classList.remove('hidden');
    shuffleBtn.classList.remove('hidden');
    removeBtn.classList.remove('hidden');
    shuffleLeft = 2;
    removeLeft = 2;
    shuffleCountEl.textContent = shuffleLeft;
    removeCountEl.textContent = removeLeft;
    round++;
    roundEl.textContent = round;

    const count = getPigCountForRound(round);
    let attempts = 0;
    const maxAttempts = count * 40;
    const largeCount = Math.floor(count / 4);
    let largeAssigned = 0;
    while (pigs.length < count && attempts < maxAttempts) {
      const radius = Math.sqrt(pigs.length + 1) * 50;
      const angle = Math.random() * 2 * Math.PI;
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      const x = centerX + Math.cos(angle) * radius;
      const y = centerY + Math.sin(angle) * radius;

      const shuffledDirs = directions.sort(() => Math.random() - 0.5);
      let dir = null;
      for (let i = 0; i < shuffledDirs.length; i++) {
        const d = shuffledDirs[i];
        const isFaceOff = pigs.some(p => {
          if (p.escaped) return false;
          const dx = p.x - x;
          const dy = p.y - y;
          const opp = (d === 'up' && p.dir === 'down' && Math.abs(dx) < (p.large ? pigSize * 1.5 : pigSize) && dy < 0) ||
                      (d === 'down' && p.dir === 'up' && Math.abs(dx) < (p.large ? pigSize * 1.5 : pigSize) && dy > 0) ||
                      (d === 'left' && p.dir === 'right' && Math.abs(dy) < (p.large ? pigSize * 1.5 : pigSize) && dx < 0) ||
                      (d === 'right' && p.dir === 'left' && Math.abs(dy) < (p.large ? pigSize * 1.5 : pigSize) && dx > 0);
          return opp;
        });
        if (!isFaceOff) {
          dir = d;
          break;
        }
      }

      if (!dir) {
        attempts++;
        continue;
      }

      const potentialBlock = pigs.some(p => {
        const pSize = p.large ? pigSize * 1.5 : pigSize;
        const curSize = largeAssigned < largeCount ? pigSize * 1.5 : pigSize;
        if (Math.abs(p.x - x) < (pSize + curSize) / 2 && Math.abs(p.y - y) < (pSize + curSize) / 2) {
          const opposite = (p.dir === 'up' && dir === 'down' && p.y > y) ||
                           (p.dir === 'down' && dir === 'up' && p.y < y) ||
                           (p.dir === 'left' && dir === 'right' && p.x > x) ||
                           (p.dir === 'right' && dir === 'left' && p.x < x);
          return opposite;
        }
        return false;
      });

      const newPigSize = largeAssigned < largeCount ? pigSize * 1.5 : pigSize;
      if (!isBlocked(x, y, { x, y, large: newPigSize > pigSize }) && !potentialBlock && x >= 0 && y >= 0 && x <= window.innerWidth - newPigSize && y <= window.innerHeight - newPigSize) {
        const isLarge = largeAssigned < largeCount;
        if (isLarge) largeAssigned++;
        createPig(x, y, dir, isLarge);
      }
      attempts++;
    }
  }

  function showVictory() {
    // æ›´æ–°èƒœåˆ©æ¶ˆæ¯ï¼ŒåŒ…å«å¥–ç‰Œä¿¡æ¯
    const level = getLevel();
    const levelName = level <= 10 ? 'åˆçº§' : level <= 20 ? 'ä¸­çº§' : 'é«˜çº§';
    const levelClass = level <= 10 ? 'text-green-400' : level <= 20 ? 'text-yellow-400' : 'text-red-400';
    
    message.innerHTML = `
      <div style="font-size: 28px; margin-bottom: 12px;">ğŸ‰ æœ¬å±€æˆåŠŸï¼</div>
      <div style="margin-bottom: 8px;">æœ¬å±€é€ƒå‡º: <strong>${score}</strong> åªåˆ˜é›…æ¬£</div>
      <div style="margin-bottom: 8px;">æ€»å¥–ç‰Œæ•°: <strong>${totalMedals}</strong></div>
      <div style="margin-bottom: 16px;">å½“å‰ç­‰çº§: <span class="${levelClass} font-bold">${levelName}</span></div>
      <button id="nextRoundBtn" style="background-color: #4f46e5; padding: 8px 16px; border-radius: 4px; cursor: pointer;">ç‚¹å‡»è¿›å…¥ç¬¬ ${round + 1} å±€</button>
    `;
    
    document.getElementById('nextRoundBtn').onclick = startGame;
    message.style.display = 'block';
  }

  // åˆå§‹åŒ–å¥–ç‰Œæ˜¾ç¤º
  updateMedalDisplay();

  startBtn.onclick = startGame;
  restartBtn.onclick = startGame;
  shuffleBtn.onclick = shuffleDirections;
  removeBtn.onclick = () => removeRandomPigs(3);
})();
</script>
</body>
</html>